#!/bin/bash
source bin/ferret.sh

run "Installing heroku plugins..." <<'EOF'
  heroku plugins:install https://github.com/ddollar/heroku-anvil
  heroku plugins:install git@github.com:heroku/heroku-orgs.git
EOF

run "Managing user..." <<'EOF'
  export $(cat .env)
  unset HEROKU_API_KEY

  set -x
  heroku members:add $HEROKU_USERNAME --org $ORG --role admin
  heroku sudo labs:enable create-bamboo --user $HEROKU_USERNAME
  heroku sudo labs:enable logplex-beta-program --user $HEROKU_USERNAME
EOF

run "Creating service apps..." <<'EOF'
  export $(cat .env)

  for s in services/*; do
    SERVICE_APP=$APP-$(basename $s)
    OPTS=$(cat $s/create.opts 2>/dev/null)
    (
      set -x
      heroku create $SERVICE_APP --org $ORG --remote s $OPTS
      heroku build $s -r $SERVICE_APP
    )
    echo
  done
EOF

run "Creating monitor app..." <<'EOF'
  export $(cat .env)

  set -x
  heroku create $APP --org $ORG
  heroku build . -r $APP -b https://github.com/nzoschke/buildpack-ferret.git
EOF

run "Joining all apps..." <<'EOF'
  export $(cat .env)
  unset HEROKU_API_KEY

  for APP in $(heroku list --all --org $ORG | grep "^$APP" | cut -d" " -f1); do
    heroku join --app $APP
  done
EOF
