#!/bin/bash
source bin/ferret.sh

run "Installing heroku plugins..." <<'EOF'
  heroku plugins:install https://github.com/ddollar/heroku-anvil
  heroku plugins:install git@github.com:heroku/heroku-orgs.git
EOF

run "Updating Procfile..." <<'EOF'
  bin/create_proc.sh monitors
EOF

run "Managing user..." <<'EOF'
  export $(cat .env)
  unset HEROKU_API_KEY

  set -x
  heroku members:add $HEROKU_USERNAME --org $ORG --role admin
  heroku sudo labs:enable create-bamboo --user $HEROKU_USERNAME
  heroku sudo labs:enable logplex-beta-program --user $HEROKU_USERNAME
EOF

run "Creating service apps..." <<'EOF'
  export $(cat .env)

  for s in services/*; do
    SERVICE_APP=$APP-$(basename $s)
    OPTS=$(cat $s/create.opts 2>/dev/null)
    (
      set -x
      heroku create $SERVICE_APP --org $ORG --remote s $OPTS
      heroku build $s -r $SERVICE_APP
    )
    echo
  done

  git remote rm s
EOF

run "Creating canary endpoints" <<'EOF'
  export $(cat .env)

  heroku create --org $ORG -s bamboo $APP-bamboo --remote s
  heroku build services/http -r $APP-bamboo
  heroku scale web=3 --app $APP-bamboo

  heroku create --org $ORG -s cedar $APP-cedar --remote s
  heroku build services/http -r $APP-cedar
  heroku scale web=3 --app $APP-cedar

  heroku create --org $ORG -s cedar $APP-cedar-endpoint --remote s
  heroku build services/http -r $APP-cedar-endpoint
  heroku scale web=3 --app $APP-cedar-endpoint
  heroku addons:add ssl:endpoint --app $APP-cedar-endpoint
  heroku domains:add www.$APP-cedar-endpoint.com --app $APP-cedar-endpoint
  openssl genrsa -out server.key 2048 $> /dev/null
  openssl req -new -key server.key -out server.csr -batch -subj "/C=US/ST=CA/O=$ORG_NAME/CN=www.$APP-cedar-endpoint.com" &> /dev/null
  openssl x509 -req -days 365 -in server.csr -signkey server.key -out server.crt &> /dev/null
  heroku certs:add server.crt server.key --app $APP-cedar-endpoint

  rm server.*
  git remote rm s
EOF

run "Creating monitor app..." <<'EOF'
  export $(cat .env)

  set -x
  heroku create $APP --org $ORG
  heroku config:set FREQ=20 APP=$APP HEROKU_API_KEY=$HEROKU_API_KEY --app $APP
  heroku build -b https://github.com/nzoschke/buildpack-ferret.git -r $APP
EOF

run "Joining all apps..." <<'EOF'
  export $(cat .env)
  unset HEROKU_API_KEY

  for APP in $(heroku list --all --org $ORG | grep "^$APP" | cut -d" " -f1); do
    heroku join --app $APP
  done
EOF

run "Scaling all procs..." <<'EOF'
  bin/scale.sh monitors 1
EOF