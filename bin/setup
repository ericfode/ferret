#!/bin/bash
source bin/ferret.sh

echo Installing heroku plugins...
(
  heroku plugins:install https://github.com/ddollar/heroku-anvil
  heroku plugins:install https://github.com/heroku/manager-cli.git
) | sed "s/^/  /"

echo Sourcing env.sample for .env...
(
  env -i HOME=$HOME bash -x -c "source env.sample" 2>&1 | awk '$1 == "++" {print $2}' > .env
  cat .env
) | sed "s/^/  /"

echo Managing org...
(
  export $(cat .env)
  unset HEROKU_API_KEY

  set -x
  heroku manager:add_user --org $ORG --user heroku.ferret.dev@gmail.com --role admin
) 2>&1 | sed "s/^/  /"

echo Creating service apps...
(
  export $(cat .env)

  for s in services/*; do
    SERVICE_APP=$APP-$(basename $s)
    (
      set -x
      heroku create $SERVICE_APP --remote s
      heroku manager:transfer --app $SERVICE_APP --to $ORG
      heroku build $s -r $SERVICE_APP
    )
  done
) 2>&1 | sed -l "s/^/  /"

echo Creating monitor app...
(
  export $(cat .env)

  set -x
  heroku create $APP
  heroku manager:transfer --app $APP --to $ORG
  heroku build . -r $APP -b https://github.com/nzoschke/buildpack-ferret
) 2>&1 | sed "s/^/  /"

echo Adding features...
(
  export $(cat .env)
  unset HEROKU_API_KEY

  set -x
  heroku sudo passes:add logplex-beta-program --app $APP
) 2>&1 | sed "s/^/  /"

