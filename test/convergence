#!/usr/bin/env ruby
require_relative "../lib/ferret"

bash(retry: 2, name: :setup, stdin: <<'EOF')
  function heroku() { $(which heroku) "$@" --app $TARGET_APP; }

  heroku info || {
    heroku plugins:install https://github.com/ddollar/heroku-anvil
    heroku plugins:install git://github.com/heroku/manager-cli.git # TODO: rename heroku-manager.git

    # create, configure, build, release and scale app
    heroku create
    heroku manager:transfer --to ferret
    heroku build -r $TARGET_APP $FERRET_DIR/app/convergence
    heroku scale crasher=1
  }
EOF

bash(name: :poll, timeout: 1800, stdin: <<'EOSH')
  # poll for change in up_at, every 10s for 150 intervals (~25 min)
  set -x
  UP_AT=$(curl -s http://ferretapp.s3.amazonaws.com/convergence_up_at)
  for i in {1..150}; do
    [ "$UP_AT" = "$(curl -s https://ferretapp.s3.amazonaws.com/convergence_up_at)" ] || exit 0
    sleep 10
  done
  exit 1
EOSH
